<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图文对评分</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
        }
        .container {
            display: grid;
            grid-template-columns: 300px 2fr 1fr;
            width: 100%;
            min-height: 100vh;
            gap: 20px;
        }
        .guide-panel {
            padding: 20px;
            background-color: #f0f7f0;
            height: 100vh;
            overflow-y: auto;
            position: sticky;
            top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid #e0e0e0;
        }
        .guide-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .guide-section h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4CAF50;
        }
        .guide-section p {
            margin: 10px 0;
            line-height: 1.6;
            color: #333;
        }
        .guide-section ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .guide-section li {
            margin: 8px 0;
            line-height: 1.4;
        }
        .main-content {
            padding: 20px;
            max-width: 100%;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }
        .right-panel {
            padding: 20px;
            background-color: #f8f9fa;
            height: 100vh;
            overflow-y: auto;
            position: sticky;
            top: 0;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .image-container {
            max-width: 100%;
            margin: 20px 0;
            text-align: center;
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .text-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f0f7f0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            border-left: 6px solid #4CAF50;
            width: 100%;
            box-sizing: border-box;
        }
        .sample-text {
            font-size: 1.3em;
            line-height: 1.8;
            color: #1a1a1a;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid #4CAF50;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .rating-form {
            width: 100%;
            box-sizing: border-box;
        }
        .rating-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
        }
        .rating-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }
        .rating-question {
            position: relative;
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
            min-height: 160px;
            width: 100%;
            box-sizing: border-box;
        }
        .rating-question p {
            margin: 0;
            padding: 0;
            font-size: 1.1em;
            color: #2c3e50;
            min-height: 50px;
            margin-bottom: 60px;
        }
        .yes-no-buttons {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 20px;
            width: 200px;
            box-sizing: border-box;
        }
        .yes-no-button {
            flex: 1;
            height: 40px;
            min-width: 90px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease;
            box-sizing: border-box;
        }
        .yes-no-button.yes {
            background-color: #dc3545;
            color: white;
            opacity: 0.8;
        }
        .yes-no-button.no {
            background-color: #4CAF50;
            color: white;
            opacity: 0.8;
        }
        .yes-no-button.selected {
            opacity: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .yes-no-button:not(.selected) {
            opacity: 0.7;
        }
        .navigation {
            margin-top: 30px;
            text-align: center;
        }
        .nav-button {
            padding: 12px 24px;
            font-size: 16px;
            margin: 0 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .nav-button:hover {
            background-color: #45a049;
        }
        .nav-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .progress {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border: 1px solid #4CAF50;
        }
        .progress-header {
            text-align: center;
            margin-bottom: 10px;
        }
        .progress h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: bold;
        }
        .progress-text {
            color: #2c3e50;
            font-size: 1em;
            margin: 5px 0;
        }
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background-color: #4CAF50;
            transition: width 0.8s ease-in-out;
        }
        @keyframes progressPulse {
            0% {
                box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2);
            }
            50% {
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            }
            100% {
                box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2);
            }
        }
        /* AI助手样式 */
        .ai-assistant {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .ai-assistant-header {
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ai-quick-actions {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .ai-quick-button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .ai-quick-button:hover {
            background-color: #45a049;
        }
        /* AI助手其他样式 */
        .ai-assistant-content {
            flex: 1;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
            margin-bottom: 10px;
        }
        .ai-assistant-input {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            background-color: white;
        }
        .ai-assistant-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .ai-assistant-input button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .ai-chat-history {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            min-height: calc(100vh - 250px);
        }
        .ai-message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .ai-message-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ai-message-icon.user {
            background-color: #e9ecef;
            color: #495057;
        }
        .ai-message-icon.assistant {
            background-color: #4CAF50;
            color: white;
        }
        .ai-message-content {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .ai-message.user .ai-message-content {
            background-color: #e9ecef;
        }
        .ai-message.assistant .ai-message-content {
            background-color: white;
        }
        .ai-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            padding: 20px;
            justify-content: center;
        }
        .ai-error {
            color: #dc3545;
            padding: 10px;
            border-left: 4px solid #dc3545;
            background-color: #fff;
            margin: 10px 0;
        }
        .ai-response-title {
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: bold;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #4CAF50;
        }
        .ai-response {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .ai-response h1 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-top: 15px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }

        .ai-response h2 {
            color: #2c3e50;
            font-size: 1.3em;
            margin-top: 12px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #3498db;
        }

        .ai-response h3 {
            color: #34495e;
            font-size: 1.1em;
            margin-top: 10px;
            margin-bottom: 8px;
            padding-left: 24px;
            border-left: 3px solid #3498db;
        }

        .ai-response strong {
            color: #c0392b;
            font-weight: 600;
        }

        .ai-response ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .ai-response ul li {
            margin: 5px 0;
            list-style-type: disc;
        }

        .ai-response ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .ai-response ol li {
            margin: 5px 0;
        }

        .ai-response p {
            margin: 10px 0;
        }

        .current-context {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .ai-translation {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid #3498db;
        }

        /* 添加星级评分显示区域的样式 */
        .rating-stars-container {
            margin: 30px 0;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .rating-stars-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            background-color: #f8f9fa;
        }

        .rating-stars-label {
            width: 120px;
            color: #2c3e50;
            font-weight: 500;
        }

        .rating-stars {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 20px;
            color: #ddd;  /* 默认灰色 */
            transition: color 0.3s ease;
        }

        .star.active {
            color: #ffd700;  /* 激活时金色 */
        }

        .star.inactive {
            color: #666;  /* 未满足时深灰色 */
        }

        /* 修改评分总结样式 */
        .rating-summary {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8) rotate(-15deg);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.6em;
            font-weight: bold;
            color: white;
            opacity: 0;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .rating-summary.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1) rotate(0);
        }

        .rating-summary i {
            font-size: 1.2em;
        }

        @keyframes stampEffect {
            0% {
                transform: translate(-50%, -50%) scale(2) rotate(-25deg);
                opacity: 0;
            }
            40% {
                transform: translate(-50%, -50%) scale(1.2) rotate(-15deg);
                opacity: 0.7;
            }
            70% {
                transform: translate(-50%, -50%) scale(0.9) rotate(5deg);
                opacity: 0.9;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0);
                opacity: 1;
            }
        }

        .rating-summary.stamp {
            animation: stampEffect 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        /* 添加页面切换动画 */
        @keyframes pageOut {
            0% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-100%);
            }
        }

        @keyframes pageIn {
            0% {
                opacity: 0;
                transform: translateX(100%);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .page-transition-out {
            animation: pageOut 0.5s ease-in-out forwards;
        }

        .page-transition-in {
            animation: pageIn 0.5s ease-in-out forwards;
        }

        /* 感谢弹窗样式 */
        .thank-you-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .thank-you-modal h2 {
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .thank-you-modal p {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #333;
        }
        .modal-close {
            padding: 10px 25px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .modal-close:hover {
            background-color: #45a049;
        }

        /* 新增星级评分样式 */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            gap: 5px;
            padding: 20px 0;
        }
        .star-rating input {
            display: none;
        }
        .star-rating label {
            cursor: pointer;
            font-size: 30px;
            color: #ddd;
            transition: color 0.2s ease-in-out;
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label,
        .star-rating input:checked ~ label {
            color: #ffd700;
        }
        .rating-dimension {
            position: relative;
            margin: 25px 0;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .rating-dimension:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            border-color: #4CAF50;
        }

        .rating-dimension h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }

        .tooltip-trigger {
            color: #4CAF50;
            cursor: help;
            font-size: 1.1em;
            transition: transform 0.3s ease;
        }

        .tooltip-trigger:hover {
            transform: scale(1.2);
        }

        .rating-tooltip {
            display: none;
            position: fixed;
            left: 20%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 450px;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            border: 3px solid #4CAF50;
        }

        .rating-tooltip::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .rating-tooltip h4 {
            color: #4CAF50;
            margin: 0 0 20px 0;
            font-size: 1.5em;
            padding-bottom: 12px;
            border-bottom: 2px solid #4CAF50;
            font-weight: bold;
        }

        .rating-tooltip ul {
            margin: 0;
            padding-left: 25px;
            list-style: none;
        }

        .rating-tooltip li {
            margin: 15px 0;
            color: #333333;
            font-size: 1.2em;
            line-height: 1.6;
            font-weight: 500;
            padding-left: 30px;
            position: relative;
            background-color: #f8f9fa;
            padding: 12px 15px 12px 35px;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }

        .rating-tooltip li::before {
            content: '•';
            position: absolute;
            left: 12px;
            color: #4CAF50;
            font-size: 1.5em;
            line-height: 1;
        }

        .rating-dimension:hover .rating-tooltip {
            display: block;
            animation: tooltipIn 0.3s ease forwards;
        }

        /* 添加动画效果 */
        @keyframes tooltipIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* 确保tooltip在所有屏幕尺寸下都居中显示 */
        @media (max-width: 1400px) {
            .rating-tooltip {
                left: 300px;
                transform: translateY(-50%);
                margin: 0;
            }
        }

        @media (max-width: 768px) {
            .rating-tooltip {
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- 添加感谢弹窗 -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="thank-you-modal" id="thankYouModal">
        <h2>感谢您的参与！</h2>
        <button class="modal-close" onclick="closeThankYouModal()">确定</button>
    </div>
    <div class="container">
        <div class="guide-panel">
            <div class="guide-section">
                <h3>评分指南</h3>
                <p>请根据以下维度对图文对进行评分：</p>
                <ul>
                    <li>图像质量（7分）</li>
                    <li>文本质量（7分）</li>
                    <li>图文一致性（7分）</li>
                </ul>
                <p>每个维度的评分标准如下：</p>
                <ul>
                    <li>7分：完美，无可挑剔</li>
                    <li>6分：非常好，仅有极小瑕疵</li>
                    <li>5分：良好，有少许瑕疵</li>
                    <li>4分：一般，瑕疵明显但可接受</li>
                    <li>3分：较差，问题较多</li>
                    <li>2分：差，问题严重</li>
                    <li>1分：极差，完全不可用</li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="image-container">
                <img id="current-image" src="" alt="评分图片">
            </div>
            <div class="text-container">
                <div class="sample-text" id="current-text"></div>
            </div>
            
            <div class="rating-section">
                <div class="rating-dimension">
                    <h3>图像质量评分 <i class="fas fa-question-circle tooltip-trigger"></i></h3>
                    <div class="rating-tooltip">
                        <h4>评分参考要点：</h4>
                        <ul>
                            <li>医学图像的清晰度和对比度</li>
                            <li>关键结构和病变区域的可见性</li>
                            <li>图像放大倍数是否合适</li>
                            <li>染色/成像方法的质量</li>
                            <li>标尺/比例尺的显示是否规范</li>
                        </ul>
                    </div>
                    <div class="star-rating" id="image-quality-rating">
                        <input type="radio" id="image-star7" name="image-quality" value="7">
                        <label for="image-star7" class="fas fa-star"></label>
                        <input type="radio" id="image-star6" name="image-quality" value="6">
                        <label for="image-star6" class="fas fa-star"></label>
                        <input type="radio" id="image-star5" name="image-quality" value="5">
                        <label for="image-star5" class="fas fa-star"></label>
                        <input type="radio" id="image-star4" name="image-quality" value="4">
                        <label for="image-star4" class="fas fa-star"></label>
                        <input type="radio" id="image-star3" name="image-quality" value="3">
                        <label for="image-star3" class="fas fa-star"></label>
                        <input type="radio" id="image-star2" name="image-quality" value="2">
                        <label for="image-star2" class="fas fa-star"></label>
                        <input type="radio" id="image-star1" name="image-quality" value="1">
                        <label for="image-star1" class="fas fa-star"></label>
                    </div>
                </div>

                <div class="rating-dimension">
                    <h3>文本质量评分 <i class="fas fa-question-circle tooltip-trigger"></i></h3>
                    <div class="rating-tooltip">
                        <h4>评分参考要点：</h4>
                        <ul>
                            <li>医学术语使用是否准确规范</li>
                            <li>实验/临床方法描述是否清晰</li>
                            <li>关键发现和结果描述是否完整</li>
                            <li>数据和参数表述是否准确</li>
                            <li>专业缩写和单位使用是否恰当</li>
                        </ul>
                    </div>
                    <div class="star-rating" id="text-quality-rating">
                        <input type="radio" id="text-star7" name="text-quality" value="7">
                        <label for="text-star7" class="fas fa-star"></label>
                        <input type="radio" id="text-star6" name="text-quality" value="6">
                        <label for="text-star6" class="fas fa-star"></label>
                        <input type="radio" id="text-star5" name="text-quality" value="5">
                        <label for="text-star5" class="fas fa-star"></label>
                        <input type="radio" id="text-star4" name="text-quality" value="4">
                        <label for="text-star4" class="fas fa-star"></label>
                        <input type="radio" id="text-star3" name="text-quality" value="3">
                        <label for="text-star3" class="fas fa-star"></label>
                        <input type="radio" id="text-star2" name="text-quality" value="2">
                        <label for="text-star2" class="fas fa-star"></label>
                        <input type="radio" id="text-star1" name="text-quality" value="1">
                        <label for="text-star1" class="fas fa-star"></label>
                    </div>
                </div>

                <div class="rating-dimension">
                    <h3>图文一致性评分 <i class="fas fa-question-circle tooltip-trigger"></i></h3>
                    <div class="rating-tooltip">
                        <h4>评分参考要点：</h4>
                        <ul>
                            <li>图像中标注的结构与文字描述是否对应</li>
                            <li>实验/临床条件描述是否与图像相符</li>
                            <li>定量/定性结果是否与图像表现一致</li>
                            <li>图像中的比例尺/标记是否与文本描述匹配</li>
                            <li>病理/影像特征描述是否准确对应</li>
                        </ul>
                    </div>
                    <div class="star-rating" id="consistency-rating">
                        <input type="radio" id="consistency-star7" name="consistency" value="7">
                        <label for="consistency-star7" class="fas fa-star"></label>
                        <input type="radio" id="consistency-star6" name="consistency" value="6">
                        <label for="consistency-star6" class="fas fa-star"></label>
                        <input type="radio" id="consistency-star5" name="consistency" value="5">
                        <label for="consistency-star5" class="fas fa-star"></label>
                        <input type="radio" id="consistency-star4" name="consistency" value="4">
                        <label for="consistency-star4" class="fas fa-star"></label>
                        <input type="radio" id="consistency-star3" name="consistency" value="3">
                        <label for="consistency-star3" class="fas fa-star"></label>
                        <input type="radio" id="consistency-star2" name="consistency" value="2">
                        <label for="consistency-star2" class="fas fa-star"></label>
                        <input type="radio" id="consistency-star1" name="consistency" value="1">
                        <label for="consistency-star1" class="fas fa-star"></label>
                    </div>
                </div>
            </div>

            <div class="navigation">
                <button id="prev-button" class="nav-button">上一题</button>
                <button id="next-button" class="nav-button">下一题</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="progress">
                <div class="progress-header">
                    <h2>评分进度</h2>
                    <div class="progress-text" id="progress-text">0/0</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
            <div class="ai-assistant">
                <div class="ai-assistant-header">
                    <h3><i class="fas fa-robot"></i> AI助手</h3>
                </div>
                <div class="ai-quick-actions">
                    <button class="ai-quick-button" onclick="explainContext()">
                        <i class="fas fa-book-open"></i> 解释上下文
                    </button>
                    <button class="ai-quick-button" onclick="explainTerms()">
                        <i class="fas fa-graduation-cap"></i> 专业术语解释
                    </button>
                    <button class="ai-quick-button" onclick="translateCaption()">
                        <i class="fas fa-language"></i> 翻译原文
                    </button>
                </div>
                <div class="ai-assistant-content" id="aiAssistantContent">
                    <div class="ai-chat-history" id="aiChatHistory"></div>
                </div>
                <div class="ai-assistant-input">
                    <input type="text" id="aiQuery" placeholder="输入要查询的内容，或选中文本后按Ctrl+Q...">
                    <button onclick="queryAI()">查询</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentIndex = 0;
        let samples = [];
        let ratings = {};
        let raterId = null;

        // 加载样本数据
        window.onload = function() {
            // 获取评分者ID
            raterId = localStorage.getItem('raterId');
            if (!raterId) {
                window.location.href = '/';
                return;
            }

            console.log('Loading samples...'); // 添加调试信息
            fetch('/static/selected_pairs.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Samples loaded:', data); // 添加调试信息
                    if (!Array.isArray(data)) {
                        throw new Error('Loaded data is not an array');
                    }
                    // 使用Fisher-Yates洗牌算法随机打乱样本顺序
                    samples = data.slice(); // 创建数组副本
                    for (let i = samples.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [samples[i], samples[j]] = [samples[j], samples[i]];
                    }
                    updateProgress();
                    showCurrentSample();
                })
                .catch(error => {
                    console.error('Error loading samples:', error);
                    alert('加载样本数据失败，请刷新页面重试');
                });
        };

        // 更新进度显示
        function updateProgress() {
            const progressText = document.getElementById('progress-text');
            const progressBar = document.getElementById('progress-bar');
            const totalRated = Object.keys(ratings).length;
            const totalSamples = samples.length;
            const progressPercentage = (totalRated / totalSamples) * 100;
            
            progressText.textContent = `${totalRated}/${totalSamples}`;
            progressBar.style.width = `${progressPercentage}%`;
        }

        // 显示当前样本
        function showCurrentSample() {
            if (currentIndex >= 0 && currentIndex < samples.length) {
                const sample = samples[currentIndex];
                console.log('Current sample:', sample); // 添加调试信息

                const imageElement = document.getElementById('current-image');
                const textElement = document.getElementById('current-text');

                // 构建图片URL
                const imageUrl = sample.image_url || `/static/images/${sample.image}`;
                console.log('Loading image from URL:', imageUrl); // 添加调试信息

                // 设置图片src
                imageElement.src = imageUrl;
                imageElement.alt = `医学图像 ${currentIndex + 1}`;
                
                // 添加图片加载错误处理
                imageElement.onerror = function() {
                    console.error('Failed to load image:', imageUrl);
                    this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><text x="50%" y="50%" text-anchor="middle">图片加载失败</text></svg>';
                    this.alt = '图片加载失败';
                };

                // 设置文本内容
                textElement.textContent = sample.text || '无文本内容';

                // 恢复之前的评分（如果有）
                const rating = ratings[sample.id || sample.image];
                if (rating) {
                    try {
                        document.querySelector(`input[name="image-quality"][value="${rating.image_quality}"]`).checked = true;
                        document.querySelector(`input[name="text-quality"][value="${rating.text_quality}"]`).checked = true;
                        document.querySelector(`input[name="consistency"][value="${rating.consistency}"]`).checked = true;
                    } catch (error) {
                        console.error('Error restoring ratings:', error);
                    }
                } else {
                    // 清除之前的评分
                    document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
                }
            } else {
                console.error('Invalid currentIndex:', currentIndex, 'samples length:', samples.length);
            }
        }

        // 提交评分
        function submitRating() {
            const imageQuality = document.querySelector('input[name="image-quality"]:checked')?.value;
            const textQuality = document.querySelector('input[name="text-quality"]:checked')?.value;
            const consistency = document.querySelector('input[name="consistency"]:checked')?.value;

            if (!imageQuality || !textQuality || !consistency) {
                alert('请完成所有维度的评分');
                return false;
            }

            const sample = samples[currentIndex];
            const rating = {
                image_id: sample.id || sample.image,  // 使用id或image作为标识符
                rater_id: raterId,
                image_quality: parseInt(imageQuality),
                text_quality: parseInt(textQuality),
                consistency: parseInt(consistency)
            };

            // 保存评分
            ratings[rating.image_id] = rating;

            // 提交到服务器
            fetch('/submit_rating', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(rating)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateProgress();
                    return true;
                } else {
                    alert('提交评分失败');
                    return false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('提交评分时发生错误');
                return false;
            });

            return true;
        }

        // 导航按钮事件处理
        document.getElementById('prev-button').addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                showCurrentSample();
            }
        });

        document.getElementById('next-button').addEventListener('click', () => {
            if (submitRating()) {
                if (currentIndex < samples.length - 1) {
                    currentIndex++;
                    showCurrentSample();
                } else {
                    // 显示完成按钮
                    document.getElementById('next-button').textContent = '完成评分';
                    document.getElementById('next-button').onclick = finishRating;
                }
            }
        });

        // 添加键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                document.getElementById('prev-button').click();
            } else if (e.key === 'ArrowRight') {
                document.getElementById('next-button').click();
            }
        });

        // 添加AI助手相关函数
        let chatHistory = [];

        function resetAIAssistant() {
            // 清空聊天历史
            chatHistory = [];
            const aiChatHistory = document.getElementById('aiChatHistory');
            aiChatHistory.innerHTML = '';

            // 添加欢迎消息
            const welcomeMessage = `
                <div class="ai-message assistant">
                    <div class="ai-message-icon assistant">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ai-message-content">
                        <p>当前文本内容为：</p>
                        <div class="current-context">${document.getElementById('current-text').textContent}</div>
                        <p>您可以：</p>
                        <ul>
                            <li>点击上方按钮快速解释内容</li>
                            <li>在下方输入框中输入要查询的内容</li>
                            <li>选中文本后按Ctrl+Q快速查询</li>
                        </ul>
                    </div>
                </div>
            `;
            aiChatHistory.innerHTML = welcomeMessage;

            // 清空输入框
            document.getElementById('aiQuery').value = '';
        }

        function addMessageToHistory(role, content, isFormatted = false) {
            const historyDiv = document.getElementById('aiChatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${role}`;
            
            const iconDiv = document.createElement('div');
            iconDiv.className = `ai-message-icon ${role}`;
            iconDiv.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-message-content';
            contentDiv.innerHTML = isFormatted ? content : `<p>${content}</p>`;
            
            messageDiv.appendChild(iconDiv);
            messageDiv.appendChild(contentDiv);
            historyDiv.appendChild(messageDiv);
            
            // 滚动到底部
            historyDiv.scrollTop = historyDiv.scrollHeight;
            
            // 保存到历史记录
            chatHistory.push({ role, content });
        }

        function formatAIResponse(response, type = 'explanation') {
            // 对于翻译类型，直接返回纯文本结果
            if (type === 'translation') {
                // 移除可能的markdown标记
                const cleanText = response
                    .replace(/[#\-*]+/g, '')  // 移除markdown标记
                    .replace(/\n+/g, '\n')    // 合并多余的换行
                    .trim();                  // 移除首尾空白
                return `<div class="ai-translation">${cleanText}</div>`;
            }

            // 其他响应的正常格式化处理
            return response
                .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
                .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
                .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.*?)$/gm, '<li>$1</li>')
                .replace(/(<li>.*?<\/li>\n*)+/g, '<ul>$&</ul>')
                .replace(/^\d+\. (.*?)$/gm, '<li>$1</li>')
                .replace(/(<li>.*?<\/li>\n*)+/g, '<ol>$&</ol>')
                .replace(/^(?!<[huol]|<li)[^\n].*$/gm, '<p>$&</p>')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        }

        async function queryAI(text) {
            let query = text;
            let requestType = 'explanation';
            
            try {
                // 检查是否是JSON格式的翻译请求
                const parsedQuery = JSON.parse(text);
                if (parsedQuery.type === 'translation') {
                    query = parsedQuery.text;
                    requestType = 'translation';
                }
            } catch (e) {
                // 如果不是JSON格式，使用原始文本
                query = text || document.getElementById('aiQuery').value.trim();
            }
            
            if (!query) return;

            // 清空输入框
            document.getElementById('aiQuery').value = '';
            
            // 添加用户消息到历史记录
            const displayText = requestType === 'translation' ? '请翻译此文本' : query;
            addMessageToHistory('user', displayText);

            // 添加加载消息
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'ai-message assistant';
            loadingMessage.innerHTML = `
                <div class="ai-message-icon assistant">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-message-content">
                    <div class="ai-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>正在${requestType === 'translation' ? '翻译' : '思考'}中...</span>
                    </div>
                </div>
            `;
            document.getElementById('aiChatHistory').appendChild(loadingMessage);

            try {
                const response = await fetch('/query_ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        context: document.getElementById('current-text').textContent,
                        history: chatHistory,
                        type: requestType
                    })
                });

                const result = await response.json();
                
                // 移除加载消息
                loadingMessage.remove();

                if (result.error) {
                    addMessageToHistory('assistant', `<div class="ai-error">
                        <i class="fas fa-exclamation-circle"></i>
                        ${requestType === 'translation' ? '翻译' : '查询'}失败：${result.error}
                    </div>`, true);
                } else {
                    const formattedResponse = formatAIResponse(result.response, requestType);
                    addMessageToHistory('assistant', formattedResponse, true);
                }
            } catch (error) {
                // 移除加载消息
                loadingMessage.remove();
                
                console.error('Error querying AI:', error);
                addMessageToHistory('assistant', `<div class="ai-error">
                    <i class="fas fa-exclamation-circle"></i>
                    ${requestType === 'translation' ? '翻译' : '查询'}失败，请稍后重试
                </div>`, true);
            }
        }

        // AI助手快捷功能
        function explainContext() {
            const text = document.getElementById('current-text').textContent;
            queryAI(`请解释这段医学报告的主要内容：${text}`);
        }

        function explainTerms() {
            const text = document.getElementById('current-text').textContent;
            queryAI(`请列出并解释这段文本中的专业术语：${text}`);
        }

        function translateCaption() {
            const text = document.getElementById('current-text').textContent;
            const translationRequest = {
                type: 'translation',
                text: text,
                system_prompt: "你是一个专业的医学翻译。请直接将输入的英文医学文本翻译成中文。要求：1. 直接给出翻译结果 2. 不要解释 3. 不要添加markdown格式 4. 不要分析 5. 保持原文的简洁性。"
            };
            queryAI(JSON.stringify(translationRequest));
        }

        // 添加文本选择事件监听
        document.addEventListener('mouseup', function(event) {
            const selectedText = window.getSelection().toString().trim();
            if (selectedText && event.ctrlKey) {
                queryAI(selectedText);
            }
        });

        // 在页面加载完成后初始化AI助手
        document.addEventListener('DOMContentLoaded', function() {
            resetAIAssistant();
        });

        // 在显示新样本时重置AI助手
        const originalShowCurrentSample = showCurrentSample;
        showCurrentSample = function() {
            originalShowCurrentSample();
            resetAIAssistant();
        };

        // 添加完成评分功能
        async function finishRating() {
            if (!submitRating()) {
                return;
            }

            try {
                // 获取所有评分数据并格式化
                const formattedRatings = samples.map(sample => {
                    const rating = ratings[sample.id || sample.image];
                    if (!rating) return null;

                    return {
                        image_id: sample.id || sample.image.replace(/\.[^/.]+$/, ""), // 移除文件扩展名
                        image_path: `/static/images/${sample.image}`,
                        text: sample.text,
                        image_quality: rating.image_quality,
                        text_quality: rating.text_quality,
                        consistency: rating.consistency,
                        total_score: rating.image_quality + rating.text_quality + rating.consistency,
                        rank: 0  // 初始化排名为0
                    };
                }).filter(r => r !== null);

                // 根据total_score计算排名
                formattedRatings.sort((a, b) => b.total_score - a.total_score);  // 降序排序
                formattedRatings.forEach((rating, index) => {
                    rating.rank = index + 1;  // 设置排名，从1开始
                });

                // 准备完整的下载数据，包含元数据
                const downloadData = {
                    rater_id: raterId,
                    evaluation_date: new Date().toISOString().replace('T', ' ').substring(0, 19),  // 格式化为 "YYYY-MM-DD HH:mm:ss"
                    total_samples: formattedRatings.length,
                    results: formattedRatings
                };

                // 创建Blob对象
                const blob = new Blob([JSON.stringify(downloadData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                // 创建下载链接
                const a = document.createElement('a');
                a.href = url;
                a.download = `rating_results_${raterId}.json`;
                
                // 显示感谢弹窗
                const modalOverlay = document.getElementById('modalOverlay');
                const thankYouModal = document.getElementById('thankYouModal');
                modalOverlay.style.display = 'block';
                thankYouModal.style.display = 'block';
                
                // 触发下载
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error finishing rating:', error);
                alert('导出评分数据时发生错误，请重试');
            }
        }

        // 修改关闭感谢弹窗的函数
        function closeThankYouModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('thankYouModal').style.display = 'none';
            // 返回首页
            window.location.href = '/';
        }
    </script>
</body>
</html> 